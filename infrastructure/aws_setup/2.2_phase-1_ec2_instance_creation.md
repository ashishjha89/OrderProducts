# AWS EC2 (Single Instance) - Create and setup

## Expected outcome

- 1 EC2 instance
- Runs **all containers** (infra + services)
- ~4 GB RAM needed ‚Üí **must fit**
- Used **on-demand**, stopped when done
- **Lowest possible cost** without fighting OOM / crashes

## Calculate CPU and memory needs

- *Run locally all docker containers and find memory requirements*.
  - I see following usage:
    - 20% / 800% CPU (there are 8 CPUs available).
    - `3.8 GB container memory`.
    - *Note*: These are for running following containers:
      - mysql, mongodb, zookeeper, broker, connect, zipkin
      - disocvery-server, api-gateway, product-service, inventory-service, order-service
    - *Note*: These are with negligible traffic, just everything running idle.
    - *Note*: `Assume OS + Docker daemon` (~400‚Äì600 MB). Also, there will be memory spent for `Page cache + JVM overhead`.
    - *Note*: `Real memory requirements ~ 4.5 GB RAM`
  - Appropriate EC2 Instance Sizes:
    - `t3.large` which has 8GB RAM. (Note t2.medium has just 4 GB RAM).

## Choose the right EC2 instance (most important decision)

### ‚úÖ Recommended instance

**`t3.large`**

| Resource         | Value          |
| ---------------- | -------------- |
| vCPU             | 2              |
| RAM              | **8 GB**       |
| Cost (eu-west-1) | ~‚Ç¨0.083 / hour |

### Why not smaller?

- Your containers already use **~4 GB**
- Add:
  - OS
  - Docker
  - JVM overhead
- `t3.medium (4 GB)` will **OOM eventually**
- `t3.large` gives safety + sanity

üí° **Cost reality**

- 15 minutes/day ‚Üí **~‚Ç¨1/month**
- This is already ‚Äúcheap enough‚Äù without pain

## Launch EC2 (minimal setup) - Manually

### AMI

- **Amazon Linux 2023**

### Kay Value Pair

- Create a new key pair
  - Type: SSH key pair
  - Format: ed25519 (preferred) or RSA (fine)
  - Name: something explicit, e.g. orderproducts-ec2-key
- NOTE: AWS will download a .pem file once ‚Äî store it safely.

How you‚Äôll use it

```bash
chmod 400 orderproducts-ec2-key.pem
ssh -i orderproducts-ec2-key.pem ec2-user@<public-ip>
```

### Storage

- **20 GB gp3**
- No extra volumes
- No backups
- No snapshots needed

### Network

- Public subnet
- Auto-assign public IPv4 ‚Üí **Enabled**

### Security Group (minimal)

- Give a custom name (e.g. orderproducts-ec2-sg)

- Inbound Rules:
  - SSH (22) ‚Üí source = your IP only
  - HTTP (8080) ‚Üí source = your IP only (for API Gateway)
  - SSH (22) -> source = com.amazonaws.eu-west-1.ec2-instance-connect (to allow SSA from AWS Console)

- Outbound Rules:
  - Allow all (this is enabled by default)

**How to get your IP:**
```bash
curl -4 ifconfig.me
# Example output: 203.0.113.42
# Use: 203.0.113.42/32 in security group
```

### Install Docker manually

SSH into EC2:

```bash
# Update system
sudo dnf update -y

# Install Docker
sudo dnf install -y docker

# Start and enable Docker
sudo systemctl start docker
sudo systemctl enable docker

# Add ec2-user to docker group
sudo usermod -aG docker ec2-user

# Verify Docker installation
docker --version

exit
```

Reconnect (important), to reload your user session, and apply updated group memberships.

### Install compose plugin manually

```bash
# Create plugin directory
sudo mkdir -p /usr/local/lib/docker/cli-plugins

# Download Docker Compose V2
sudo curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 \
  -o /usr/local/lib/docker/cli-plugins/docker-compose

# Make executable
sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

# Create symlink (optional, for backward compatibility)
sudo ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose

# Verify installation
docker compose version
```

### Install Git and clone project manually

```bash
# Install Git
sudo dnf install -y git

# Clone repository (replace with your GitHub username)
cd /home/ec2-user
git clone https://github.com/ashishjha89/OrderProducts.git
chown -R ec2-user:ec2-user OrderProducts

# Pull Docker images (as ec2-user)
cd OrderProducts/infrastructure/
docker compose pull

# Start containers
docker compose up -d
```

Wait ~1‚Äì2 minutes.

Verify:

```bash
docker ps
docker stats
```

## Launch EC2 (minimal setup) with User-Data

### User data script

```bash
#!/bin/bash
set -euxo pipefail

########################################
# 1. System update
########################################
dnf update -y

########################################
# 2. Install Docker
########################################
dnf install -y docker

systemctl enable docker
systemctl start docker

########################################
# 3. Add ec2-user to docker group
########################################
usermod -aG docker ec2-user

########################################
# 4. Install Docker Compose plugin (v2)
########################################
mkdir -p /usr/local/lib/docker/cli-plugins

curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 \
  -o /usr/local/lib/docker/cli-plugins/docker-compose

chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

# Optional backward-compatibility symlink
ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose

########################################
# 5. Install Git
########################################
dnf install -y git

########################################
# 6. Clone OrderProducts repository
########################################
cd /home/ec2-user

# Clone only if not already present (idempotent)
if [ ! -d "OrderProducts" ]; then
  git clone https://github.com/ashishjha89/OrderProducts.git
fi

chown -R ec2-user:ec2-user /home/ec2-user/OrderProducts

########################################
# 7. Run docker-compose as ec2-user
########################################

su - ec2-user <<'EOF'
set -euxo pipefail

# Apply docker group immediately
newgrp docker <<'INNER_EOF'

cd ~/OrderProducts/infrastructure

# Pull images
docker compose pull

# Start stack
docker compose up -d

INNER_EOF
EOF

########################################
# 8. Log completion
########################################
echo "User-data setup completed successfully" > /var/log/user-data-complete.log
```

### Verify

Once EC2 is running:

```bash
# Connect from local system [Optionally]
ssh -i orderproducts-ec2-key.pem ec2-user@<public-ip>

# Either continue from local system or connect to EC2 using AWS Console
docker --version
docker compose version
docker ps
docker stats
```