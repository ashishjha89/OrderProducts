# AWS EC2 (Single Instance) - Troubleshooting Guide

## Issue: Services not registering with Eureka

**Symptoms**: Eureka dashboard empty or shows "No instances available"

**Solutions:**
```bash
# 1. Check if discovery-server is healthy
docker logs discovery-server | tail -50

# 2. Check if service can reach Eureka
docker exec product-service curl http://discovery-server:8761/eureka/apps

# 3. Check service logs
docker logs product-service | grep -i eureka

# 4. Verify environment variables
docker exec product-service env | grep EUREKA

# 5. Check network connectivity
docker exec product-service ping -c 3 discovery-server
```

**Common causes:**
- Discovery server not fully started (wait 60-90 seconds)
- Services started before discovery server (restart services)
- Network configuration issue (restart docker-compose)

---

## Issue: API Gateway returns 503 Service Unavailable

**Symptoms**: `curl http://<EC2_IP>:8080/api/products` returns 503

**Solutions:**
```bash
# 1. Check if backend services are registered in Eureka
curl http://<EC2_IP>:8761/eureka/apps | grep product-service

# 2. Check API Gateway logs
docker logs api-gateway | tail -100

# 3. Check if API Gateway can resolve service names
docker exec api-gateway ping -c 3 product-service

# 4. Check LoadBalancer configuration
docker exec api-gateway curl http://product-service:8080/actuator/health
```

**Common causes:**
- Backend service not registered yet (wait for Eureka registration)
- Backend service unhealthy (check service logs)
- Route misconfiguration (verify application.properties)

---

## Issue: Kafka connection failures

**Symptoms**: inventory-service or order-service logs show Kafka errors

**Solutions:**
```bash
# 1. Check if broker is running and healthy
docker logs broker | tail -50
docker exec broker kafka-topics --bootstrap-server broker:29092 --list

# 2. Check if services can reach broker
docker exec inventory-service nc -zv broker 29092

# 3. Check Kafka environment variables
docker exec inventory-service env | grep KAFKA

# 4. Check Zookeeper (Kafka dependency)
docker logs zookeeper | tail -50
```

**Common causes:**
- Broker not fully started (wait 60 seconds after zookeeper)
- Zookeeper unhealthy (check zookeeper logs)
- Memory issues (check `docker stats`)

---

## Issue: High memory usage / OOM kills

**Symptoms**: Docker containers restarting, `docker stats` shows high memory usage

**Solutions:**
```bash
# 1. Check which service is using memory
docker stats --no-stream

# 2. Check for OOM kills
dmesg | grep -i "out of memory"
docker inspect <container_id> | grep OOM

# 3. Check swap usage (if enabled)
free -h
```

**Fixes:**

**Option 1: Reduce JVM heap (Dockerfile)**
```dockerfile
# Change from:
ENTRYPOINT ["java","-XX:InitialRAMPercentage=25","-XX:MaxRAMPercentage=75","-jar","/app/app.jar"]

# To:
ENTRYPOINT ["java","-XX:InitialRAMPercentage=20","-XX:MaxRAMPercentage=60","-jar","/app/app.jar"]
```

**Option 2: Reduce container limits (docker-compose.yml)**
```yaml
# Change from:
mem_limit: 512m

# To:
mem_limit: 384m  # For less critical services
```

**Option 3: Upgrade instance**
```bash
# Upgrade from t3.large (8GB) to t3.xlarge (16GB)
# Stop instance, change instance type, start instance
```

---

## Issue: Cannot access from local machine

**Symptoms**: Connection timeout when accessing `http://<EC2_IP>:8080`

**Solutions:**

**1. Check Security Group:**
```bash
# Get your current IP
curl ifconfig.me

# Verify security group allows your IP
aws ec2 describe-security-groups \
  --group-ids sg-xxxxx \
  --query 'SecurityGroups[0].IpPermissions'
```

**2. Check from EC2 (should work):**
```bash
# SSH to EC2
ssh -i key.pem ec2-user@<EC2_IP>

# Test locally
curl http://localhost:8080/api/products  # Should work
```

**3. Check Docker port binding:**
```bash
docker compose ps
# Should show: 0.0.0.0:8080->8080/tcp
# NOT: 127.0.0.1:8080->8080/tcp
```

**4. Check EC2 firewall (if Amazon Linux):**
```bash
sudo iptables -L -n | grep 8080
# Should not have DROP rules for 8080
```

---

## Issue: Services start but then crash

**Symptoms**: `docker compose ps` shows services as "Restarting" or "Exit 1"

**Solutions:**
```bash
# 1. Check logs for crash reason
docker logs <service_name>

# 2. Check for dependency issues
docker compose logs | grep -i "error\|exception\|failed"

# 3. Check resource limits
docker stats

# 4. Verify all dependencies are healthy
docker compose ps | grep "healthy"
```

**Common causes:**
- Database not ready (healthcheck failed)
- Environment variable missing
- Out of memory
- Application configuration error
